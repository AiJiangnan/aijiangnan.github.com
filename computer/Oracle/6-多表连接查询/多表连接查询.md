# 多表连接查询

在很多情况下，需要同时查询多个表的数据，这时我们就要使用到多表连接查询，多表连接查询知识点如下：

![image01](0002.png)

## 一、SQL92的多表连接查询

### 1. 笛卡尔集

```sql
-- 多表连接查询
SELECT * FROM emp;-- 14 条
SELECT * FROM dept;-- 4 条
-- 笛卡尔积
SELECT * FROM emp, dept;-- 56
```

说明：上面查询的结果显然不是我们想要的，所以我们要消除笛卡尔集。

### 2. 等值连接

```sql
-- 通过指定两张表的关联条件来去除无意义数据
SELECT * FROM emp,dept WHERE emp.deptno=dept.deptno;
SELECT * FROM emp e,dept d WHERE e.deptno=d.deptno;
SELECT * FROM emp e,dept d WHERE emp.deptno=dept.deptno;--错误
-- 查询所有员工的姓名, 职位及部门名称
SELECT ename,job,dname FROM emp e,dept d WHERE e.deptno=d.deptno;
-- 查询所有员工的姓名, 职位, 部门编号及部门名称
SELECT ename,job,e.deptno,dname FROM emp e,dept d WHERE e.deptno=d.deptno;

SELECT e.ename,e.job,d.deptno,d.dname
FROM emp e,dept d
WHERE e.deptno = d.deptno;
```

说明：多表查询时：

- 同名列在查询时必须指定是哪张表的列;
- 表名可以使用别名，但一旦使用别名，则不能再使用原名;
- 复杂查询时，子句可以分行写。

### 3. 非等值连接

```sql
-- 查询20 部门员工的姓名, 入职日期, 薪水和薪水等级
SELECT e.ename,e.hiredate,e.sal,s.grade
FROM emp e, salgrade s
WHERE e.sal BETWEEN s.losal AND s.hisal
AND e.deptno = 20;
```

### 4. 外连接

查询除了满足条件的信息外, 还需查询某张表不满足条件的信息外连接使用“(+)”来表明，左外连接“(+)”主右边，右外连接“(+)”放左边。

**左外连接**

```sql
-- 查询所有员工的编号,姓名以及领导的编号和姓名, 包含没有领导的员工的信息
SELECT e1.empno,e1.ename,e1.mgr,e2.ename
FROM emp e1,emp e2
WHERE e1.mgr=e2.empno(+);-- 左外连接
```

**右外连接**

```sql
SELECT e2.empno,e2.ename,e2.mgr,e1.ename
FROM emp e1,emp e2-- e1表示领导, e2 表示员工
WHERE e1.empno(+)=e2.mgr;-- 右外连接
-- 查询所有部门的信息及部门的平均工资
SELECT d.*,NVL(AVG(e.sal),0) avg_sal
FROM emp e,dept d
WHERE e.deptno(+) = d.deptno
GROUP BY d.deptno, d.dname, d.loc
ORDER BY d.deptno;
```

### 5. 自连接

```sql
-- 查询所有员工的编号,姓名以及领导的编号和姓名
SELECT e1.empno,e1.ename,e1.mgr,e2.ename
FROM emp e1, emp e2
WHERE e1.mgr=e2.empno;
```

总结：n张表连接查询, 至少需要n-1个连接条件

```sql
-- 查询20部门员工的姓名, 部门名称, 薪水及薪水等级
SELECT e.ename,d.dname,e.sal,s.grade
FROM emp e,dept d,salgrade s
WHERE e.deptno=d.deptno
AND e.sal BETWEEN s.losal AND s.hisal
AND e.deptno=20;
```

## 二、SQL99的多表查询

### 1. 交叉连接

使用CROSS JOIN来实现交叉连接，作用与SQL92中的笛卡尔积一样。

```sql
-- [1] 交叉连接: cross join
SELECT * FROM emp, dept;
SELECT * FROM emp CROSS JOIN dept;
```

### 2. 自然连接

自然连接使用关键字NATURAL JOIN，作用就是按照两表所有同名字段进行等值连接。

```sql
SELECT * FROM emp,dept WHERE emp.deptno=dept.deptno;
SELECT * FROM emp NATURAL JOIN dept;
-- 查询30部门所有员工的编号, 姓名, 部门编号和部门名称
SELECT e.empno,e.ename,deptno,d.dname FROM emp e NATURAL JOIN dept d WHERE deptno=30;
```

说明：在自然连接中，同名字段不能用表(表别名)前缀修饰。

### 3. USEING连接

自然连接不能指定同名字段，所以要用到USING关键字来指定两表进行等值连接的同名字段。

```sql
SELECT e.empno,e.ename,deptno,d.dname FROM emp e JOIN dept d USING(deptno) WHERE deptno=30;
```

说明：与自然连接一样，同名字段不允许使用表前缀。

### 4. ON连接

使用ON建立连接, 做用是通过ON子句来指定表之间的连接条件，WHERE中写过滤条件。

```sql
-- [4] 使用ON建立连接,做用是通过ON子句来指定表之间的连接条件
-- 查询20 部门员工的姓名, 入职日期, 薪水和薪水等级
SELECT e.ename,e.hiredate,e.sal,s.grade FROM emp e JOIN salgrade s ON e.sal BETWEEN s.losal AND s.hisal WHERE e.deptno=20;
-- 查询30部门所有员工的编号, 姓名, 部门编号和部门名称
SELECT e.empno,e.ename,e.deptno,d.dname FROM emp e JOIN dept d ON e.deptno=d.deptno WHERE d.deptno=30;
```

### 5. 外连接

**自连接**

```sql
-- 使用SQL99实现自连接
SELECT e1.empno,e1.ename,e2.empno,e2.ename
FROM emp e1
JOIN emp e2
ON e1.mgr = e2.empno;
```

**外连接**

- 左外连接：left [outer] join
- 右外连接：right [outer] join
- 全外连接：full [outer] join

```sql
-- 左外连接: LEFT [OUTER] JOIN
-- 右外连接: RIGHT [OUTER] JOIN
-- 全外连接: FULL [OUTER] JOIN
SELECT e1.empno, e1.ename, e2.empno, e2.ename
FROM emp e1
LEFT OUTER JOIN emp e2
ON e1.mgr = e2.empno;

SELECT e2.empno, e2.ename, e1.empno, e1.ename
FROM emp e1
RIGHT JOIN emp e2
ON e2.mgr = e1.empno;

SELECT e2.empno, e2.ename, e1.empno, e1.ename
FROM emp e1
FULL JOIN emp e2
ON e2.mgr = e1.empno;
```

说明：OUTER一般省略不写。

**更多表的连接**

```sql
-- 查询20 部门员工的姓名, 部门名称, 薪水及薪水等级
SELECT e.ename, d.dname, e.sal, s.grade
FROM emp e
JOIN dept d
ON e.deptno = d.deptno
JOIN salgrade s
ON e.sal BETWEEN s.losal AND s.hisal
WHERE e.deptno = 20;

SELECT e.ename, d.dname, e.sal, s.grade
FROM emp e
NATURAL JOIN dept d
JOIN salgrade s
ON e.sal BETWEEN s.losal AND s.hisal
WHERE deptno = 20;
```


