<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <script src="../../../js/markdown.js"></script>
    <script src="../../../js/jquery.min.js"></script>

    <link rel="stylesheet" href="../../../css/content.css">
    <title>JDBC分层开发</title>
</head>

<body>
    <textarea hidden id="content">
<!--Markdown从这里开始  -->
# JDBC分层开发

引入分层开发的概念开发一个员工管理系统，面向接口编程。常用的分层模式有MVC架构，分为model（模型层）、view（视图层）、Controller（控制层）。

- 模型层：主要用于和数据库产生交互（接口）
- 视图层：主要是前台的页面及效果（图片、样式，...）
- 控制层：主要是协调M和V之间的纽带

**本实例实现功能：**

1. 添加员工信息
2. 查询所有员工信息
3. 根据员工编号查询员工信息
4. 根据员工的姓名查询员工信息（模糊查询）
5. 根据员工的编号修改员工的工资
6. 删除员工的信息
7. 统计各部门信息及员工人数和平均工资

## 一、项目结构搭建

**1. 创建相应的包**

- entity：放置实体类的包
- dao：Data Access Object，模型层，从数据库查询出来的数据创建的对象
- dao.impl：放置实现dao下接口的包
- util：放置工具类的包
- view：放置控制台界面编写的包
- test：测试类，可随意命名

整个项目的文件结构图：

![img01](0002.png)

**2. 准备相应文件**

- 前面写好的数据库工具类DBUtil复制到util包下
- 数据库配置文件jdbc.properties复制到src文件下夹下，并改用scott用户

## 二、项目结构编写

**1. 编写Emp实体类**

在entity包下写，根据员工表的字段来创建对象：

```java
import java.sql.Date;

public class Emp {

	private int empno;
	private String ename;
	private String job;
	private int mgr;
	private Date hiredate;
	private double sal;
	private double comm;
	private int deptno;

	public int getEmpno() {
		return empno;
	}

	public void setEmpno(int empno) {
		this.empno = empno;
	}

	public String getEname() {
		return ename;
	}

	public void setEname(String ename) {
		this.ename = ename;
	}

	public String getJob() {
		return job;
	}

	public void setJob(String job) {
		this.job = job;
	}

	public int getMgr() {
		return mgr;
	}

	public void setMgr(int mgr) {
		this.mgr = mgr;
	}

	public Date getHiredate() {
		return hiredate;
	}

	public void setHiredate(Date hiredate) {
		this.hiredate = hiredate;
	}

	public double getSal() {
		return sal;
	}

	public void setSal(double sal) {
		this.sal = sal;
	}

	public double getComm() {
		return comm;
	}

	public void setComm(double comm) {
		this.comm = comm;
	}

	public int getDeptno() {
		return deptno;
	}

	public void setDeptno(int deptno) {
		this.deptno = deptno;
	}

	@Override
	public String toString() {
		return empno + "\t" + ename + "\t" + job + "\t" + mgr + "\t" + hiredate + "\t" + sal + "\t" + comm + "\t" + deptno;
	}
}
```

**2. 编写Dept实体类**

在entity包下写，根据部门表的字段来编写：

```java
public class Dept {

	private int deptno;
	private String dname;
	private String loc;
	private int cnt;
	private double sal;

	public int getDeptno() {
		return deptno;
	}

	public void setDeptno(int deptno) {
		this.deptno = deptno;
	}

	public String getDname() {
		return dname;
	}

	public void setDname(String dname) {
		this.dname = dname;
	}

	public String getLoc() {
		return loc;
	}

	public void setLoc(String loc) {
		this.loc = loc;
	}

	public int getCnt() {
		return cnt;
	}

	public void setCnt(int cnt) {
		this.cnt = cnt;
	}

	public double getSal() {
		return sal;
	}

	public void setSal(double sal) {
		this.sal = sal;
	}

	@Override
	public String toString() {
		return deptno + "\t" + dname + "\t" + loc + "\t" + cnt + "\t" + sal;
	}
}
```

**3. 实现功能的接口创建**

在dao包下编写，实现功能的接口：

```java
import java.util.List;

import com.ajn.emp.entity.Dept;
import com.ajn.emp.entity.Emp;
/**
 * 功能实现的接口
 */
public interface EmpDao {
	/**
	 * 1. 添加员工信息
	 * @param emp
	 * @return
	 */
	boolean addEmp(Emp emp);
	/**
	 * 2. 查询所有员工信息
	 * @return
	 */
	List<Emp> queryAll();
	/**
	 * 3. 根据员工编号查询员工信息
	 * @param empno
	 * @return
	 */
	Emp queryEmpByEmpno(int empno);
	/**
	 * 4. 根据员工的姓名查询员工信息（模糊查询）
	 * @param name
	 * @return
	 */
	List<Emp> queryEmpByEname(String name);
	/**
	 * 5. 根据员工的编号修改员工的工资
	 * @param empno
	 * @param sal
	 * @return
	 */
	boolean updateSalByEmpno(int empno,double sal);
	/**
	 * 6. 删除员工的信息
	 * @param empno
	 * @return
	 */
	boolean deleteEmp(int empno);
	/**
	 * 7. 统计各部门信息及员工人数和平均工资
	 * @return
	 */
	List<Dept> queryDeptInfo();
}
```

**4. 工具类准备**

除了使用DBUtil数据库工具类外，再编写一个日期处理的工具类如下：

```java
import java.sql.Date;
import java.text.ParseException;
import java.text.SimpleDateFormat;

public class DateUtil {

	public static Date string2Date(String date) {
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		try {
			return new Date(sdf.parse(date).getTime());
		} catch (ParseException e) {
			e.printStackTrace();
		}
		return null;
	}

	public static String date2String(Date date) {
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		return sdf.format(date);
	}
}
```

## 三、项目代码完成

**1. 数据库查询与更新操作方法类**

在dao.impl包下，编写BaseDao类来简化数据库操作的编程：

```java
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.beanutils.BeanUtils;

import com.ajn.emp.util.DBUtil;

public abstract class BaseDao {

	protected boolean update(String sql, Object... args) {
		Connection conn = DBUtil.getConn();
		PreparedStatement pstmt = DBUtil.getPstmt(conn, sql);
		DBUtil.bindParams(pstmt, args);
		try {
			int rc = pstmt.executeUpdate();
			if (rc > 0) {
				return true;
			}
		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			DBUtil.closeAll(null, pstmt, conn);
		}
		return false;
	}

	protected <T> List<T> query(Class<T> cls, String sql, Object... args) {
		List<T> list = new ArrayList<T>();

		Connection conn = DBUtil.getConn();
		PreparedStatement pstmt = DBUtil.getPstmt(conn, sql);
		ResultSet rs = null;
		DBUtil.bindParams(pstmt, args);

		try {
			rs = pstmt.executeQuery();
			ResultSetMetaData metaData = pstmt.getMetaData();
			while (rs.next()) {
				T bean = cls.newInstance();
				for (int i = 1; i <= metaData.getColumnCount(); i++) {
					BeanUtils.setProperty(bean, metaData.getColumnLabel(i).toLowerCase(), rs.getObject(i));
				}
				list.add(bean);
			}
		} catch (SQLException e) {
			e.printStackTrace();
		} catch (InstantiationException e) {
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			e.printStackTrace();
		} catch (Exception e) {
			e.printStackTrace();
		}
		return list.size() > 0 ? list : null;
	}
}
```

说明：

- 更新的方法可以进行数据库的所有DML（增、删、改）操作
- 查询的方法使用泛型定义，可以适用于任何实体类
- 生成set方法时要使用commons-beanutils、commons-collections、commons-logging三个jar包

**2. 实现模型层接口的类**

在dao.impl包下编写实现EmpDao接口的类，并继承BaseDao抽象类：

```java
import java.util.List;

import com.ajn.emp.dao.EmpDao;
import com.ajn.emp.entity.Dept;
import com.ajn.emp.entity.Emp;

public class EmpDaoImpl extends BaseDao implements EmpDao {

	@Override
	public boolean addEmp(Emp emp) {
		String sql = "INSERT INTO emp VALUES (?,?,?,?,?,?,?,?)";
		Object[] args = { emp.getEmpno(), emp.getEname(), emp.getJob(), emp.getMgr(), emp.getHiredate(), emp.getSal(), emp.getComm(), emp.getDeptno() };
		return update(sql, args);
	}

	@Override
	public List<Emp> queryAll() {
		String sql = "SELECT * FROM emp";
		return query(Emp.class, sql);
	}

	@Override
	public Emp queryEmpByEmpno(int empno) {
		String sql = "SELECT * FROM emp WHERE empno=7369";
		List<Emp> list = query(Emp.class, sql);
		return list == null ? null : list.get(0);
	}

	@Override
	public List<Emp> queryEmpByEname(String name) {
		String sql = "SELECT * FROM emp WHERE ename LIKE ?";
		return query(Emp.class, sql, "%" + name + "%");
	}

	@Override
	public boolean updateSalByEmpno(int empno, double sal) {
		String sql = "UPDATE emp SET sal=? WHERE empno=?";
		return update(sql, sal, empno);
	}

	@Override
	public boolean deleteEmp(int empno) {
		String sql = "DELETE FROM emp WHERE empno=?";
		return update(sql, empno);
	}

	@Override
	public List<Dept> queryDeptInfo() {
		String sql = "SELECT d.*,COUNT(e.empno) cnt,AVG(e.sal) sal FROM emp e,dept d WHERE e.deptno(+)=d.deptno GROUP BY d.deptno,d.dname,d.loc ORDER BY d.deptno";
		return query(Dept.class, sql);
	}
}
```

**3. 编写控制台界面并实现方法**

在view包下编写控制台界面并实现所有功能的方法：

```java
import java.util.List;
import java.util.Scanner;

import com.ajn.emp.dao.EmpDao;
import com.ajn.emp.dao.impl.EmpDaoImpl;
import com.ajn.emp.entity.Dept;
import com.ajn.emp.entity.Emp;
import com.ajn.emp.util.DateUtil;

public class MainMenu {
	private Scanner in = new Scanner(System.in);
	private Emp emp = new Emp();
	private EmpDao dao = new EmpDaoImpl();

	public void showMenu() {
		System.out.println(""
				+ "┌───────────────────────────────────┐\n"
				+ "│\t\t\t欢迎使用员工管理系统\t\t\t│\n"
				+ "└───────────────────────────────────┘");
		while (true) {
			System.out.println(""
					+ "┌───────────────────────────────────┐\n"
					+ "│\t1. 添加员工信息\t\t\t\t\t\t│\n"
					+ "│\t2. 查询所有员工信息\t\t\t\t\t│\n"
					+ "│\t3. 根据员工编号查询员工信息\t\t\t\t│\n"
					+ "│\t4. 根据员工的姓名查询员工（模糊查询）\t\t│\n"
					+ "│\t5. 根据员工的编号修改员工的工资\t\t\t│\n"
					+ "│\t6. 删除员工的信息\t\t\t\t\t│\n"
					+ "│\t7. 统计各部门信息及员工人数和平均工资\t\t│\n"
					+ "│\t0. 退出\t\t\t\t\t\t\t│\n"
					+ "└───────────────────────────────────┘");
			System.out.print("请选择操作选项：");
			switch (in.nextInt()) {
				case 1:addEmp();break;
				case 2:queryAll();break;
				case 3:queryEmpByEmpno();break;
				case 4:queryEmpByEname();break;
				case 5:updateSalByEmpno();break;
				case 6:deleteEmp();break;
				case 7:queryDeptInfo();break;
				case 0:System.out.println("感谢使用，再见！");return;
				default:System.out.println("输入错误，请重新输入！");
			}
		}
	}

	private void queryEmpByEname() {
		System.out.print("请输入员工姓名：");
		String ename = in.next();
		List<Emp> list = dao.queryEmpByEname(ename);
		System.out.println("─────────────────────────────────────────────────────────────────────");
		System.out.println("empno\tename\tjob\tmgr\thiredate\tsal\tcomm\tdeptno\t");
		System.out.println("─────────────────────────────────────────────────────────────────────");
		for (int i = 0; i < list.size(); i++) {
			System.out.println(list.get(i));
		}
		System.out.println("─────────────────────────────────────────────────────────────────────");
	}

	private void queryDeptInfo() {
		System.out.println("─────────────────────────────────────────");
		System.out.println("deptno\tdname\tloc\tcnt\tsal");
		System.out.println("─────────────────────────────────────────");
		List<Dept> dept = dao.queryDeptInfo();
		for (int i = 0; i < dept.size(); i++) {
			System.out.println(dept.get(i));
		}
		System.out.println("─────────────────────────────────────────");
	}

	private void deleteEmp() {
		System.out.print("请输入要删除员工编号：");
		int empno = in.nextInt();
		if (dao.deleteEmp(empno)) {
			System.out.println("删除成功！");
		} else {
			System.out.println("删除失败！");
		}
	}

	private void updateSalByEmpno() {
		System.out.print("请输入员工编号：");
		int empno = in.nextInt();
		System.out.print("请输入修改薪资：");
		double sal = in.nextDouble();
		if (dao.updateSalByEmpno(empno, sal)) {
			System.out.println("修改成功！");
		} else {
			System.out.println("修改失败！");
		}
	}

	private void queryEmpByEmpno() {
		System.out.print("请输入员工编号：");
		int empno = in.nextInt();
		emp = dao.queryEmpByEmpno(empno);
		if (emp != null) {
			System.out.println("─────────────────────────────────────────────────────────────────────");
			System.out.println("empno\tename\tjob\tmgr\thiredate\tsal\tcomm\tdeptno\t");
			System.out.println("─────────────────────────────────────────────────────────────────────");
			System.out.println(emp);
			System.out.println("─────────────────────────────────────────────────────────────────────");
		} else {
			System.out.println("查无此人！");
		}
	}

	private void queryAll() {
		List<Emp> list = dao.queryAll();
		System.out.println("─────────────────────────────────────────────────────────────────────");
		System.out.println("empno\tename\tjob\tmgr\thiredate\tsal\tcomm\tdeptno\t");
		System.out.println("─────────────────────────────────────────────────────────────────────");
		for (int i = 0; i < list.size(); i++) {
			System.out.println(list.get(i));
		}
		System.out.println("─────────────────────────────────────────────────────────────────────");
	}

	private void addEmp() {
		System.out.print("请输入员工编号：");
		emp.setEmpno(in.nextInt());
		System.out.print("请输入员工姓名：");
		emp.setEname(in.next());
		System.out.print("请输入员工职位：");
		emp.setJob(in.next());
		System.out.print("请输入领导编号：");
		emp.setMgr(in.nextInt());
		System.out.print("请输入入职日期：");
		emp.setHiredate(DateUtil.string2Date(in.next()));
		System.out.print("请输入工资：");
		emp.setSal(in.nextDouble());
		System.out.print("请输入提成：");
		emp.setComm(in.nextDouble());
		System.out.print("请输入部门编号：");
		emp.setDeptno(in.nextInt());

		if (dao.addEmp(emp)) {
			System.out.println("添加成功！");
		} else {
			System.out.println("添加失败！");
		}
	}
}
```

**4. 编写主方法进行测试**

```java
import com.ajn.emp.view.MainMenu;

public class Main {
	public static void main(String[] args) {
		new MainMenu().showMenu();
	}
}
```

<!--Markdown从这里结束  -->
	</textarea>
    <div id="preview" class="container"></div>
    <script>
        $("#preview").html(marked($("#content").val()));
        $("table").addClass("table table-bordered table-striped");
    </script>

</body>

</html>