<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <script src="../../../js/markdown.js"></script>
    <script src="../../../js/jquery.min.js"></script>

    <link rel="stylesheet" href="../../../css/content.css">
    <title>完整性约束</title>
</head>

<body>
    <textarea hidden id="content">
<!--Markdown从这里开始  -->
# 完整性约束

在数据库设计的时候，表的数据有一定的取值范围和联系，多表之间的数据有时也有一定的参照关系。在创建表和修改表时，可通过定义约束条件来保证数据的完整性和一致性。约束条件是一些规则，在对数据进行插入、删除和修改时要对这些规则进行验证，从而起到约束作用。

![img01](0002.png)

**命名规则推荐采用：约束类型_约束字段:**

- 非空约束：NN_表名_列名


- 唯一约束：UK_表名_列名


- 主键约束：PK_表名


- 外键约束：FK_表名_列名


- 检查约束：CK_表名_列名

## 一、主键约束

要求主键列数据唯一，并且不允许为空。主键可以包含表的一列或多列，如果包含表的多列，则需要在表级定义。

**1. 在表级定义主键约束**

```sql
-- [1] 主键约束: PRIMARY KEY
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3) PRIMARY KEY,
	sname VARCHAR2(15),
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	clazz VARCHAR2(30),
	email VARCHAR2(30)
	CONSTRAINTS pk_student PRIMARY KEY (sno)
	-- PRIMARY KEY (sno)-- 简化版
);
```

联合主键, 只能在表级别定义。

```sql
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15),
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	clazz VARCHAR2(30),
	email VARCHAR2(30)
	CONSTRAINTS pk_student PRIMARY KEY (sno, sname)
);
```

**2. 在列级定义主键约束**

```sql
DROP TABLE student;
CREATE TABLE student (
	no NUMBER(3) CONSTRAINTS pk_student PRIMARY KEY,-- 在列级别定义主键约束
	sno NUMBER(3) PRIMARY KEY,
	sname VARCHAR2(15),
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	clazz VARCHAR2(30),
	email VARCHAR2(30)
);
```

## 二、非空约束

要求该列不能为空，非空约束只能在列级别定义。

```sql
-- [2] 非空约束: NOT NULL
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	-- sname VARCHAR2(15) CONSTRAINTS nn_student_sname NOT NULL,
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	clazz VARCHAR2(30),
	email VARCHAR2(30),
	CONSTRAINTS pk_student PRIMARY KEY (sno)
);
```

## 三、唯一约束

要求该列唯一，允许为空。

```sql
-- [3] 唯一约束: UNIQUE
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	clazz VARCHAR2(30),
	email VARCHAR2(30) UNIQUE,
	CONSTRAINTS pk_student PRIMARY KEY (sno)
	-- CONSTRAINTS uk_student_email UNIQUE (email)
);
```

## 四、检查约束

某列取值范围限制、格式限制等，如年龄的约束。

```sql
-- [4] 检查约束: CHECK
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男' CHECK(gender IN ('男', '女')),
	age NUMBER(2) CHECK (age BETWEEN 18 AND 30),
	sdate DATE,
	clazz VARCHAR2(30),
	email VARCHAR2(30),
	CONSTRAINTS pk_student PRIMARY KEY (sno),
	CONSTRAINTS uk_student_email UNIQUE (email)
	-- CONSTRAINTS ck_student_age CHECK (age BETWEEN 18 AND 30)
);
```

## 五、外键约束

用于两表间建立关系，需要指定引用主表的那列。外键通常用来约束两个表之间的数据关系，定义外键的那张表称为子表，另一张表称为主表。在表的创建过程中，应该先创建主表，后创建子表。

```sql
-- [5] 外键约束: FOREIGN KEY
-- 创建班级表
CREATE TABLE clazz (
	cno NUMBER(3) PRIMARY KEY,
	cname VARCHAR2(30) NOT NULL UNIQUE,
	cdate DATE
);
-- 创建学生表
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	email VARCHAR2(30),
	cno NUMBER(3) REFERENCES clazz (cno),-- 在列级别定义外键约束
	CONSTRAINTS pk_student PRIMARY KEY (sno),
	CONSTRAINTS uk_student_email UNIQUE (email),
	CONSTRAINTS ck_student_age CHECK (age BETWEEN 18 AND 30),
	CONSTRAINTS ck_student_gender CHECK(gender IN ('男', '女'))
	-- 在表级别定义外键约束
	-- CONSTRAINTS fk_student_cno FOREIGN KEY (cno) REFERENCES clazz (cno)
);
```

## 六、联级删除

添加外键约束后，在删除主表信息时，会先检查该信息在子表中有没有被引用。如果有关联的子表信息，那么主表中的信息不允许被删除，必须先删除子表中的相关信息,才能删除主表中的信息。这种情况下，我们可以设置联级删除，来执行相关操作。

对于主表的删除和修改主键值的操作，会对依赖关系产生影响，以删除为例：当要删除主表的某个记录（即删除一个主键值，那么对依赖的影响可采取下列3种做法：

- RESTRICT方式：只有当依赖表中没有一个外键值与要删除的主表中主键值相对应时，才可执行删除操作。
- CASCADE方式：将依赖表中所有外键值与主表中要删除的主键值相对应的记录一起删除。
- SET NULL方式：将依赖表中所有与主表中被删除的主键值相对应的外键值设为空值。

```sql
INSERT INTO clazz VALUES (202, 'JAVA大牛班', SYSDATE);
INSERT INTO clazz VALUES (102, 'Android小牛班', SYSDATE);
INSERT INTO clazz VALUES (222, 'PHP牛牛班', SYSDATE);
INSERT INTO clazz VALUES (401, '大数据', SYSDATE);
INSERT INTO clazz VALUES (502, 'UI女神班', SYSDATE);
INSERT INTO student VALUES(112, '张无忌', '男', 18, to_date('2017-3-28', 'yyyy-mm-dd'), 'test@123.com', 401);
SELECT * FROM student;
SELECT * FROM clazz;
-- 删除编号为222 的班级信息
DELETE FROM clazz WHERE cno=222;
DELETE FROM student WHERE cno=222;
-- 设置级联删除
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	email VARCHAR2(30),
	cno NUMBER(3),
	CONSTRAINTS pk_student PRIMARY KEY (sno),
	CONSTRAINTS uk_student_email UNIQUE (email),
	CONSTRAINTS ck_student_age CHECK (age BETWEEN 18 AND 30),
	CONSTRAINTS ck_student_gender CHECK(gender IN ('男', '女')),
	CONSTRAINTS fk_student_cno FOREIGN KEY (cno) REFERENCES clazz (cno) ON DELETE CASCADE-- 级联删除,同时将子表中关联的数据一起删除
);

DELETE FROM clazz WHERE cno=401;
-- 设置级联设空
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	email VARCHAR2(30),
	cno NUMBER(3),
	CONSTRAINTS pk_student PRIMARY KEY (sno),
	CONSTRAINTS uk_student_email UNIQUE (email),
	CONSTRAINTS ck_student_age CHECK (age BETWEEN 18 AND 30),
	CONSTRAINTS ck_student_gender CHECK(gender IN ('男', '女')),
	CONSTRAINTS fk_student_cno FOREIGN KEY (cno) REFERENCES clazz (cno) ON DELETE SET NULL-- 级联设空,将子表中关联数据设置为null
);
-- 删除班级表(强制删除主表)
-- 先删除约束, 再删除表格
DROP TABLE clazz CASCADE CONSTRAINTS;
```

## 七、修改表时添加约束

修改表时只能添加或者删除约束，不能修改约束。

```sql
-- 删除约束
ALTER TABLE student DROP CONSTRAINTS ck_student_gender;
-- 在修改表格的同时,添加约束
CREATE TABLE clazz (
	cno NUMBER(3) PRIMARY KEY,
	cname VARCHAR2(30) NOT NULL UNIQUE,
	cdate DATE
);
DROP TABLE student;
CREATE TABLE student (
	sno NUMBER(3),
	sname VARCHAR2(15) NOT NULL,
	gender CHAR(3) DEFAULT '男',
	age NUMBER(2),
	sdate DATE,
	email VARCHAR2(30),
	cno NUMBER(3)
);
ALTER TABLE student ADD CONSTRAINTS pk_student PRIMARY KEY (sno);
ALTER TABLE student ADD CONSTRAINTS uk_student_email UNIQUE (email);
ALTER TABLE student ADD CONSTRAINTS ck_student_age CHECK (age BETWEEN 18 AND 30);
ALTER TABLE student DROP CONSTRAINTS ck_student_gender CHECK (gender IN ('男', '女'));
ALTER TABLE student DROP CONSTRAINTS fk_student_cno FOREIGN KEY (cno) REFERENCES clazz (cno);
```
<!--Markdown从这里结束  -->
	</textarea>
    <div id="preview" class="container"></div>
    <script>
        $("#preview").html(marked($("#content").val()));
        $("table").addClass("table table-bordered table-striped");
    </script>
</body>

</html>